(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[519],{8864:function(e,t,l){Promise.resolve().then(l.bind(l,3523))},3523:function(e,t,l){"use strict";l.r(t),l.d(t,{default:function(){return u}});var i=l(7437),o=l(2265);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let s=(0,l(1066).Z)("Loader2",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]);var a=l(8184),r=l(4697),n=l(6463),c=l(9936),d=l(869);function u(){let e=(0,n.useRouter)(),[t,l]=(0,o.useState)([]),[u,h]=(0,o.useState)(!1),[m]=(0,o.useState)(0),[g,v]=(0,o.useState)(""),[b,p]=(0,o.useState)(""),[f,x]=(0,o.useState)(!1),j=(0,o.useRef)(null),w=e=>new Promise((t,l)=>{if(e.size>31457280){l(Error("ファイルサイズが大きすぎます（30MB以下にしてください）"));return}let i=document.createElement("video"),o=document.createElement("canvas"),s=o.getContext("2d");if(!s){l(Error("Canvas 2D context が利用できません"));return}let a=setTimeout(()=>{l(Error("クライアントサイド生成がタイムアウトしました"))},1e4);i.onloadedmetadata=()=>{if(console.log("動画メタデータ読み込み完了:",{videoWidth:i.videoWidth,videoHeight:i.videoHeight,duration:i.duration}),i.videoWidth>0&&i.videoHeight>0){let e,t;let l=i.videoWidth,s=i.videoHeight;if(console.log("動画寸法:",{videoWidth:l,videoHeight:s}),l>400||s>300){let i=Math.min(400/l,300/s);e=Math.floor(l*i),t=Math.floor(s*i)}else e=l,t=s;console.log("計算されたCanvasサイズ:",{width:e,height:t}),o.width=e,o.height=t,console.log("Canvasサイズ設定完了:",{canvasWidth:o.width,canvasHeight:o.height,videoWidth:i.videoWidth,videoHeight:i.videoHeight});let a=Math.min(1,i.duration/2);i.currentTime=a}else console.error("動画の寸法が取得できません"),l(Error("動画の寸法が取得できません"))},i.onseeked=()=>{try{console.log("フレーム抽出開始:",{currentTime:i.currentTime,videoWidth:i.videoWidth,videoHeight:i.videoHeight,canvasWidth:o.width,canvasHeight:o.height}),s.fillStyle="#000000",s.fillRect(0,0,o.width,o.height),s.drawImage(i,0,0,o.width,o.height);let e=o.toDataURL("image/jpeg",.8);console.log("サムネイル生成完了:",{thumbnailUrl:e.substring(0,50)+"...",canvasWidth:o.width,canvasHeight:o.height,thumbnailLength:e.length}),clearTimeout(a),t(e)}catch(e){console.error("サムネイル生成エラー:",e),clearTimeout(a),l(e)}},i.onerror=e=>{console.error("動画読み込みエラー:",e),clearTimeout(a),l(Error("動画の読み込みに失敗しました"))},i.src=URL.createObjectURL(e),i.load(),i.oncanplay=()=>{console.log("動画再生可能:",{videoWidth:i.videoWidth,videoHeight:i.videoHeight,readyState:i.readyState})}});(0,o.useEffect)(()=>{let t=localStorage.getItem("access_token"),l=localStorage.getItem("user_email");if(!t||!l){console.log("認証情報が不足しています。ログインページに移動します。"),e.push("/auth/login");return}console.log("認証確認完了:",{hasToken:!!t,email:l})},[e]);let y=()=>{let t=localStorage.getItem("access_token"),l=localStorage.getItem("user_email");return!!t&&!!l||(v("ログインが必要です。ログインページに移動します。"),setTimeout(()=>{e.push("/auth/login")},2e3),!1)},_=async e=>{if(!y())throw Error("認証が必要です");let t=null;try{p("クライアントサイドでサムネイル生成中..."),console.log("クライアントサイドサムネイル生成開始..."),t=await w(e),console.log("クライアントサイド生成成功:",{thumbnailLength:t.length,thumbnailStart:t.substring(0,50),isDataUrl:t.startsWith("data:image/")}),p("クライアントサイドでサムネイル生成完了！"),setTimeout(()=>p(""),3e3)}catch(e){console.log("クライアントサイド生成失敗:",e),p("サムネイル生成に失敗しました"),setTimeout(()=>p(""),3e3)}let l=new FormData;l.append("video_file",e);let i=localStorage.getItem("user_email"),o=localStorage.getItem("user_id");i&&l.append("user_email",i),o&&l.append("user_id",o);let s=localStorage.getItem("sb:req:draft");if(s)try{let e=JSON.parse(s);if(console.log("保存されたドラフトデータ:",e),e.club&&(l.append("club_type",e.club),console.log("クラブタイプを追加:",e.club)),e.problems&&e.problems.length>0){let t=e.problems.join(", ");l.append("swing_form",t),console.log("スイング形式（問題）を追加:",t)}e.note&&(l.append("swing_note",e.note),console.log("スイングメモを追加:",e.note))}catch(e){console.error("ドラフトデータの解析に失敗:",e)}for(let[e,t]of(console.log("FormDataの内容確認:"),l.entries()))console.log("".concat(e,":"),t);let a="https://aps-bbc-02-dhdqd5eqgxa7f0hg.canadacentral-01.azurewebsites.net/api/v1",r="".concat(a,"/upload-video");console.log("アップロード情報:",{apiUrl:a,uploadUrl:r,userEmail:i,userId:o,fileName:e.name,fileSize:e.size,clientThumbnailGenerated:!!t});try{let e=await fetch(r,{method:"POST",body:l});if(console.log("アップロードレスポンス:",{status:e.status,statusText:e.statusText,headers:Object.fromEntries(e.headers.entries())}),!e.ok){let t;try{t=await e.json()}catch(l){t={detail:e.statusText}}throw Error("アップロード失敗: ".concat(t.detail||e.statusText))}let i=await e.json();console.log("アップロード成功:",i),console.log("アップロード結果の詳細:",{user_id:i.user_id,video_url:i.video_url,thumbnail_url:i.thumbnail_url,club_type:i.club_type,swing_form:i.swing_form}),i.user_id&&(localStorage.setItem("user_id",i.user_id),console.log("新しいuser_idをlocalStorageに保存:",i.user_id));let o=t||i.thumbnail_url;return console.log("サムネイルURL決定:",{clientThumbnail:t?t.substring(0,50)+"...":"なし",serverThumbnail:i.thumbnail_url||"なし",finalThumbnail:o?o.substring(0,50)+"...":"なし",thumbnailLength:null==o?void 0:o.length}),{video_url:i.video_url,thumbnail_url:o}}catch(e){throw console.error("動画アップロードエラー:",e),e}},N=async e=>{if(e.length){h(!0),v("動画をアップロード中...");try{let o=[],s=[];if(e.forEach(e=>{if(e.size>31457280){s.push(e.name);return}}),s.length>0){v("以下のファイルは30MBを超えているため選択できません: ".concat(s.join(", "))),setTimeout(()=>v(""),5e3),h(!1);return}for(let l of e)try{var t,i;let e=await _(l),s=crypto.randomUUID(),a=URL.createObjectURL(l);o.push({id:s,file:l,url:a,size:l.size,name:l.name});let r={...JSON.parse(localStorage.getItem("sb:req:draft")||"{}"),videoThumb:e.thumbnail_url,videoUrl:e.video_url};console.log("ドラフト保存:",{videoThumb:(null===(t=e.thumbnail_url)||void 0===t?void 0:t.substring(0,50))+"...",videoUrl:e.video_url,thumbnailLength:null===(i=e.thumbnail_url)||void 0===i?void 0:i.length}),localStorage.setItem("sb:req:draft",JSON.stringify(r))}catch(e){console.error("ファイル ".concat(l.name," のアップロード失敗:"),e),v("ファイル ".concat(l.name," のアップロードに失敗しました")),setTimeout(()=>v(""),5e3),h(!1);return}l(e=>{let t=[...e,...o],l=t.map(e=>({id:e.id,name:e.name,size:e.size,url:e.url}));return localStorage.setItem("sb:req:files",JSON.stringify(l)),t}),v(""),h(!1),console.log("[upload] 動画アップロード完了。次へボタンを押して次の画面に進んでください。")}catch(e){console.error("動画処理エラー:",e),v("動画の処理に失敗しました"),setTimeout(()=>v(""),5e3),h(!1)}}},S=async()=>{var e;let t=window;if(t.showOpenFilePicker)try{console.log("[picker] Using File System Access API");let e=await t.showOpenFilePicker({multiple:!0,types:[{description:"Videos",accept:{"video/*":[".mp4",".mov",".webm",".m4v"]}}],excludeAcceptAllOption:!0}),l=await Promise.all(e.map(e=>e.getFile()));console.log("[picked]",l.length),N(l);return}catch(e){console.log("File picker cancelled or failed:",e)}console.log("[picker] Using fallback input"),null===(e=j.current)||void 0===e||e.click()},k=e=>{l(t=>{let l=t.find(t=>t.id===e);return l&&URL.revokeObjectURL(l.url),t.filter(t=>t.id!==e)})},T=e=>"".concat((e/1048576).toFixed(1),"MB");return(0,i.jsxs)(c.T,{title:"動画アップロード",subtitle:"添削依頼する動画を選択してください",currentStep:m,totalSteps:4,children:[t.length>0&&!u&&(0,i.jsxs)("div",{className:"space-y-4",children:[(0,i.jsxs)("div",{className:"bg-blue-500/20 border border-blue-500/30 rounded-lg p-4 text-blue-300 text-sm",children:[(0,i.jsx)("div",{className:"font-bold mb-2",children:"次の画面に渡される情報:"}),(0,i.jsxs)("div",{children:["動画ファイル数: ",t.length,"個"]}),(0,i.jsxs)("div",{children:["ファイル名: ",t.map(e=>e.name).join(", ")]}),(0,i.jsxs)("div",{children:["合計サイズ: ",T(t.reduce((e,t)=>e+t.size,0))]})]}),(0,i.jsx)("div",{className:"text-center",children:(0,i.jsx)(d.Jr,{onClick:()=>{let l=t.map(e=>({id:e.id,name:e.name,size:e.size,url:e.url}));localStorage.setItem("selectedVideos",JSON.stringify(l)),console.log("動画ファイル情報を保存:",l),e.push("/user/request-club")},className:"w-full",children:"次へ"})})]}),(0,i.jsxs)("div",{className:"text-center",children:[(0,i.jsxs)("div",{className:"flex flex-col items-center mb-8",children:[(0,i.jsx)("button",{type:"button",onClick:S,disabled:u,"aria-label":"動画をアップロード",className:"bg-white rounded-full h-[54px] px-6 flex items-center gap-3 shadow-lg hover:shadow-xl transition-all duration-200 active:scale-95 ".concat(u?"opacity-50 cursor-not-allowed":""),children:u?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s,{className:"text-violet-600 animate-spin",size:20}),(0,i.jsx)("span",{className:"text-violet-600 font-medium",children:"アップロード中..."})]}):(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(a.Z,{className:"text-violet-600",size:20}),(0,i.jsx)("span",{className:"text-violet-600 font-medium",children:"動画をアップロード"})]})}),g&&(0,i.jsx)(d.Ou,{message:g}),b&&(0,i.jsx)("div",{className:"bg-blue-500/20 border border-blue-500/30 rounded-lg p-3 text-blue-300 text-sm",children:(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)(s,{className:"animate-spin",size:16}),(0,i.jsx)("span",{children:b})]})}),t.length>0&&!u&&(0,i.jsxs)("div",{className:"bg-green-500/20 border border-green-500/30 rounded-lg p-4 text-green-300 text-sm",children:[(0,i.jsx)("div",{className:"font-bold mb-2",children:"✅ 動画アップロード完了！"}),(0,i.jsxs)("div",{children:[t.length,"個の動画が正常にアップロードされました"]}),(0,i.jsx)("div",{className:"mt-2 text-xs opacity-80",children:"下の「次へ」ボタンを押して、クラブ選択画面に進んでください"})]})]}),(0,i.jsx)("input",{ref:j,type:"file",accept:"video/*,.mp4,.mov,.webm",multiple:!0,onChange:e=>{var t;let l=Array.from(null!==(t=e.target.files)&&void 0!==t?t:[]);console.log("[picked]",l.length),N(l),e.currentTarget.value=""},className:"hidden"}),t.length>0&&(0,i.jsxs)("div",{className:"space-y-3 mb-8",children:[(0,i.jsx)("h3",{className:"text-white text-lg font-medium mb-4",children:"選択された動画"}),t.map(e=>(0,i.jsxs)("div",{className:"rounded-2xl bg-white/10 border border-white/15 p-3 flex items-center gap-3",children:[(0,i.jsx)("video",{src:e.url,muted:!0,playsInline:!0,className:"w-16 h-10 object-cover rounded-lg bg-black/20"}),(0,i.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,i.jsx)("p",{className:"text-white text-sm font-medium truncate",children:e.name}),(0,i.jsx)("p",{className:"text-white/70 text-xs",children:T(e.size)})]}),(0,i.jsx)("button",{onClick:()=>k(e.id),"aria-label":"".concat(e.name,"を削除"),className:"w-8 h-8 rounded-full bg-red-500/20 hover:bg-red-500/30 flex items-center justify-center transition-colors",children:(0,i.jsx)(r.Z,{className:"text-red-400",size:16})})]},e.id))]})]})]})}},8184:function(e,t,l){"use strict";l.d(t,{Z:function(){return i}});/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let i=(0,l(1066).Z)("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]])},4697:function(e,t,l){"use strict";l.d(t,{Z:function(){return i}});/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let i=(0,l(1066).Z)("X",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]])}},function(e){e.O(0,[137,971,23,744],function(){return e(e.s=8864)}),_N_E=e.O()}]);